name: Test VFBquery Examples

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test-examples:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.8

      - name: Install dependencies
        run: |
            python -m pip install --upgrade pip
            pip install -r requirements.txt
            pip install deepdiff

      - name: Run examples from README.md
        run: |
          cat README.md | grep -e '```python' -e '```' -e '^[^`]*$' | sed -e '/^```python/,/^```/!d' -e '/^```/d' > test_examples.py
          python test_examples.py

      - name: Test examples from README.md
        run: |
            python -c """
            import re
            import sys
            import json
            from deepdiff import DeepDiff
            from io import StringIO

            with open('README.md', 'r') as f:
            content = f.read()

            code_blocks = re.findall(r'```(.*?)```', content, re.DOTALL)
            python_blocks = [block for block in code_blocks if block.startswith('python')][::2]
            json_blocks = [block for block in code_blocks if block.startswith('json')]

            for python_block, json_block in zip(python_blocks, json_blocks):
            # Remove the 'python' and 'json' headers
            python_code = python_block.replace('python', '').strip()
            expected_json = json.loads(json_block.replace('json', '').strip())

            # Capture the output of the Python code
            sys.stdout = StringIO()
            exec(python_code)
            output = sys.stdout.getvalue().strip()

            # Compare the output JSON with the expected JSON
            output_json = json.loads(output)
            diff = DeepDiff(expected_json, output_json, ignore_order=True)

            if diff:
                print('Error in example:')
                print(python_code)
                print('Expected JSON:')
                print(expected_json)
                print('Output JSON:')
                print(output_json)
                print('Difference:')
                print(diff)
                sys.exit(1)

            print('All examples passed.')
            sys.stdout = sys.__stdout__"""